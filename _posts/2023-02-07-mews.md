---
title: "MEWS Bot = Mastodon nEWS"
date: 2023-02-07
categories: 
  - "poradniki"
  - "projekty"
tags: 
  - "api"
  - "bot"
  - "curl"
  - "github"
  - "mastodon"
  - "mastodonnews"
  - "mews"
  - "okopress"
  - "opensource"
  - "php"
  - "rss"
  - "rzeczpospolita"
  - "theguardian"
  - "xml"
image: "/images/mews.png"
---

[ Go to english version of this post / Przejd藕 do angielskiej wersji tego wpisu](https://blog.tomaszdunia.pl/mews-eng/)

Spis treci:
* TOC
{:toc}


W poprzednich wpisach pisaem o Mastodonie, wic pomylaem, 偶e pocign ten temat nieco dalej i przedstawi jeden z moich maych projekt贸w. Mastodon z ka偶dym dniem zyskuje coraz wiksz popularno, jednak nie jest jeszcze na tyle du偶ym i uznanym medium, 偶eby zwr贸ciy na niego uwag wiksze koncerny medialne, kt贸re najbardziej udzielaj si tam, gdy jest najwiksza publiczno i to ilociowo, a nie koniecznie zawsze jakociowo. W takich sytuacjach trzeba poradzi sobie samemu, co te偶 zrobiem. W taki spos贸b powsta pomys MEWS, czyli Mastodon nEWS.

## Od czego zacz?

> Skoro portale informacyjne nie publikuj na Mastodonie i chyba na razie nie maj planu tego robi to trzeba zrobi bota, kt贸ry bdzie to robi za nie!

Taka myl wpada mi kt贸rego dnia do gowy. Tak si skada, 偶e **API Mastodona jest do proste do obsugi przez cURL**, a skoro jest proste do obsugi przez cURL to r贸wnie proste bdzie napisanie skryptu w PHP, kt贸ry bdzie scrapowa (pobiera dane z) RSS danego portalu informacyjnego, przetwarza dane i publikowa je w formie toota na Mastodonie.

No dobrze, ale od jakiego portalu chciabym zacz? Najlepiej od takiego, kt贸rego najbardziej brakuje mi na Mastodonie! Najbardziej lubianym przeze mnie polskojzycznym 藕r贸dem informacji jest [Rzeczpospolita](https://rp.pl), za dostp do kt贸rej pac niewielk miesiczn opat, bo znajduje si za paywallem. Na marginesie taki ukad jest dla mnie w peni zrozumiay, bo porzdne dziennikarstwo nie powinno by darmowe.

## Budujemy bota RSS -> Mastodon

**Kompletny kod bota**, kt贸ry jest bohaterem tego wpisu jest dostpny na [moim GitHubie pod tym linkiem](https://github.com/to3k/mews-rzeczpospolita/blob/main/rzeczpospolita.php). Pisz o tym, bo nie bd wrzuca tutaj caego kodu linijka po linijce, a jedynie opisz najistotniejsze jego fragmenty. Na wstpie chciabym te偶 zaznaczy, 偶e **nie jestem z zawodu programist**, a jedynie samoukiem-hobbist, wic m贸j kod mo偶e nie by perfekcyjny, czy te偶 zgodny z jakimikolwiek przyjtymi standardami w wiecie dev. Mo偶e te偶 nie by maksymalnie zoptymalizowany, ale liczy si to, 偶e dziaa tak jak powinien.

Zaczynamy od utworzenia dw贸ch plik贸w:

- **_rzeczpospolita.txt_** - bd w nim przechowywane linki artyku贸w, kt贸re ju偶 przerzucilimy z RSS do Mastodona, 偶eby nie duplikowa toot贸w,

- **_rzeczpospolita.php_** - skrypt g贸wny bota.

Chciaem, aby pisany przeze mnie bot by w miar uniwersalny i mo偶na go byo niewielkim nakadem pracy przerobi tak, aby dziaa dla innego portalu oraz by atwy do u偶ycia przez inne osoby, wic na pocztek skryptu wycignem sobie pewne zmienne (a mo偶e raczej stae ), kt贸rych w kodzie u偶yj dopiero p贸藕niej. Tak, wic na wstpie potrzebujemy okreli trzy rzeczy. Pierwsz z nich jest _**token**_, czyli nasz prywatny klucz dostpowy do API Mastodona. Pozyskuje si go poprzez wejcie do _Ustawie_ konta, na kt贸rym bdziemy publikowa automatyczne tooty wygenerowane przez bota, nastpnie zakadka _Tworzenie aplikacji_ i przycisk _Nowa aplikacja_. Podajemy dowoln nazw aplikacji, ja podaem "MEWS bot" i w sekcji _Zakres_ **odznaczamy** wszystko poza "write", co oznacza, 偶e aplikacja, kt贸r wanie tworzymy bdzie miaa pene uprawnienia do publikowania na tym koncie. Nastpn rzecz, kt贸r musimy okreli do poprawnego dziaania skryptu to **adres instancji**, na kt贸rej zarejestrowalimy konto bota. Trzecia zmienna to **limit znak贸w obowizujcy na tej偶e instancji** (rate limit). Domylnie jest to 500, ale istniej instancje, kt贸re dopuszczaj wicej (np. na naszej rodzimej instancji 101010.pl jest to 2048 znak贸w).

```php
$token = "[WKLEJ TUTAJ TOKEN]";
$instance_url = "[WKLEJ TUTAJ URL INSTANCJI]";
$instance_rate_limit = 500;
```

Dalej tworzymy tablic z linkami do kana贸w RSS portalu, kt贸rego artykuy chcemy publikowa przez bota. Mo偶e to by jeden lub kilka link贸w oddzielonych przecinkami. Rzeczpospolita ma jeden g贸wny feed RSS, wic dla niego ta instrukcja bdzie wygldaa tak.

```php
$urls = array(
    "https://www.rp.pl/rss_main"
);
```

Ale je偶eli chcielibymy odfiltrowa treci tematycznie to mo偶emy ograniczy si do podrzdnych tematycznych feed贸w RSS, kt贸rych bdzie wicej, i zrobi to tak.

```php
$urls = array(
    "https://moto.rp.pl/rss/2651-motoryzacja",
    "https://cyfrowa.rp.pl/rss/2991-cyfrowa",
    "https://energia.rp.pl/rss/4351-energetyka"
);
```

Wczytujemy zawarto pliku _rzeczpospolita.txt_, 偶eby p贸藕niej odfiltrowa te artykuy z kanau RSS, kt贸re ju偶 wczeniej udostpnilimy.

```php
$file = file_get_contents("rzeczpospolita.txt");
```

Przy u偶yciu ptli _foreach_ przechodzimy przez wszystkie linki do kana贸w RSS podane w tablicy _$urls_.

```php
foreach($urls as $url)
{...}
```

Przy u偶yciu funkcji _simplexml\_load\_file()_ konwertujemy zawarty kanau RSS do formy tablicy wielopoziomowej o nazwie _$feeds_.

```php
$feeds = simplexml_load_file($url);
```

Znowu u偶ywamy ptli _foreach_, ale tym razem dzielimy feed RSS na poszczeg贸lne artykuy (_item'y_).

```php
foreach ($feeds->channel->item as $item)
```

Przyjrzyjmy si teraz jak wyglda skadnia takiego przykadowego _item'u_ w kanale RSS:

```xml
<item>
    <guid isPermaLink="true">https://cyfrowa.rp.pl/technologie/art37858421-chinski-robot-jak-terminator-zmienia-ksztalt-i-przelewa-sie-przez-kraty</guid>
    <mainProfile><![CDATA[Technologie]]></mainProfile>
    <title><![CDATA[Chiski robot jak Terminator. Zmienia ksztat i przelewa si przez kraty]]></title>
    <link><![CDATA[https://cyfrowa.rp.pl/technologie/art37858421-chinski-robot-jak-terminator-zmienia-ksztalt-i-przelewa-sie-przez-kraty]]></link>
    <description><![CDATA[Zespoowi badaczy z Chin udao si opracowa rozwizanie niczym z film贸w science fiction. Stworzyli zmiennoksztatnego robota, umiecili go w zminiaturyzowanym modelu wizienia i pokazali, jak potrafi wydosta si on zza krat.]]></description>
    <category>Technologie</category>
    <pubDate>Sat, 28 Jan 2023 11:56:00 +0100</pubDate>
    <enclosure length="0" type="image/jpeg" url="https://i.gremicdn.pl/image/free/497cf5a2a1609a24bd425fe122641ed9/?t=resize:fill:600:300,enlarge:1"/>
    <author>Micha Duszczyk</author>
    <redirectUrl/>
    <pay_status>Preview</pay_status>
</item>
```

Specyfika plik贸w XML jest taka, 偶e informacje zawarte s pomidzy odpowiednimi znacznikami, kt贸rych nazwy okrelaj to co przechowuj. Ustalmy jak chcielibymy, aby wyglda nasz toot, a wic co jest nam potrzebne do jego skonstruowania. Moja wizja bya taka:

> **TYTU**  
> SEPARATOR (5 MYLNIKW)  
> **HASHTAGI TEMATYCZNE**  
> SEPARATOR (5 MYLNIKW)  
> **KRTKI OPIS (JE呕ELI TRZEBA TO SKRCONY ZGODNIE Z LIMITEM ZNAKW INSTANCJI)**  
> SEPARATOR (ZNAK NOWEJ LINII)  
> **LINK**

Skoro ju偶 wiemy co jest nam potrzebne to zacznijmy wyciga te informacje z pliku XML. Zaczniemy od linku. Wydaje si, 偶e zaczynamy od koca, ale to specjalne dziaanie ze wzgldu na to, 偶e nie ma potrzeby pobiera reszty je偶eli oka偶e si, 偶e dany link znajduje si ju偶 w pliku _rzeczpospolita.txt_, a to oznaczaoby, 偶e zosta ju偶 przez nas przetworzony wczeniej, a artyku, do kt贸rego odsya by ju偶 wrzucany przez bota na Mastodona. Link znajduje si pomidzy znacznikami _<link>...</link>_, wic z racji tego, 偶e u偶ylimy wczeniej funkcji _simplexml\_load\_file()_, to mo偶emy si do niego dobra u偶ywajc jedynie prostej notacji _$item->link_. Pozostaje nam jeszcze przeformatowa pobrane dane na typ string przy u偶yciu funkcji _strval()_ oraz usun niepotrzebne elementy z cigu.

```php
$link = strval($item->link); // Pobieramy link z XML i formatujemy na cig
$link = str_replace("<![CDATA[", "", $link); // Usuwamy "<![CDATA[" z pocztku cigu
$link = str_replace("]]>", "", $link); // Usuwamy "]]>" z koca cigu
```

W ten spos贸b zapisalimy w zmiennej o nazwie _$link_ cig znak贸w, kt贸ry jest **linkiem** do artykuu. Teraz trzeba jeszcze musimy sprawdzi czy wystpuje on w pliku _rzeczpospolita.txt_. U偶yjemy do tego funkcji _str\_contains()_, kt贸ra zwraca warto _true_ (prawda), gdy w cigu _$file_ zawiera si cig _$link_, a _false_ (fasz), gdy si w nim nie zawiera.

```php
if(str_contains($file, $link))
{
    continue; // Je偶eli wystpuje to pomi ten item i kontynuuj wykonywanie ptli
}
else
{
    ... // Je偶eli nie wystpuje to wykonaj dalsz cz kodu, o kt贸rej w dalszej czci wpisu
}
```

Gdy wiemy ju偶, 偶e nie publikowalimy wczeniej toota o danym artykule to przechodzimy do pozyskania pozostaych rzeczy z feedu RSS. **Tytu** i **opis** artykuu pobieramy analogicznie do tego jak robilimy to z linkiem, usuwajc przy tym zbdne mieci.

```php
$title = strval($item->title);
$title = str_replace("<![CDATA[", "", $title);
$title = str_replace("]]>", "", $title);
$description = strval(strip_tags($item->description));
$description = str_replace("<![CDATA[", "", $description);
$description = str_replace("]]>", "", $description);
```

Pozostaj nam jeszcze **tematyczne hashtagi**, kt贸re bd odpowiednikami kategorii do jakich zosta zakwalifikowany danych artyku. Dla hashtag贸w sytuacja jest nieco inne ni偶 dla wczeniej pobranych danych, bo o ile artykuy Rzeczpospolitej przypisywane s przewa偶nie jedynie do jednej kategorii, tak dla innych portali czsto artyku nale偶y do wicej ni偶 jednej i jest wicej ni偶 jeden parametr _<category>...</category>_ do pobrania. Tworzc bota MEWS stwierdziem, 偶e hashtagi s do istotn czci, bo bd umo偶liwiay obserwujcym atwe odfiltrowanie temat贸w, kt贸re ich interesuje lub wrcz przeciwnie - nie interesuj ich. Do tego musz by unikatowe, dlatego na ich kocu dopisuj MEWS, wtedy u偶ytkownik ma pewno, 偶e blokujc dany hashtag blokuje tylko tooty pochodzce od bota MEWS.

Przygotowanie cigu hastag贸w rozpoczynamy od utworzenia tablicy _$hashtag_. Nastpnie ponownie korzystamy z ptli _foreach_ i w ten spos贸b zbieramy wszystkie wartoci znajdujce si pod parametrem _category_ danego artykuu. Zebrane dane obrabiam odpowiednio. Dodaj ka偶dej kategorii prefix _#_ i suffix _MEWS_. Na koniec wrzucam wszystkie hashtagi w utworzon wczeniej tablic, dodajc przy tym na kocu jeszcze jeden hashtag - _#MEWS_ - nie bdcy kategori, a jedynie bdcy wsp贸lnym hashtagiem dla wszystkich toot贸w bota, i cz wszystkie elementy tej tablicy w jeden cig, separujc je odstpem (spacja).

```php
$hashtag = array();
foreach($item->category as $category)
{
    $category = ucwords(strtolower(strval($category)));
    $category = str_replace(" ", "", $category);
    $category = "#".$category."MEWS";
    $hashtag[] = $category;
}
$hashtag[] = "#MEWS";
$hashtags = implode(" ", $hashtag);
```

W ten spos贸b pod zmienn _$hashtags_ przechowuj cig znak贸w ze wszystkimi hashtagami, kt贸re zacz za chwil do toota.

Teraz, gdy ju偶 znamy dugo wszystkich czci skadowych musimy wyliczy czy zmieci nam si to wszystko do jednego toota. Natomiast je偶eli oka偶e si, 偶e wiadomo jest w takiej formie du偶sza ni偶 przyjty na pocztku limit to bdziemy musieli skr贸ci opis zapisany w zmiennej _$description_ tak, aby zmieci si w limicie. Zacznijmy od wyliczenia limitu dla opisu ze wzoru:

> **Limit dla opisu** = Dopuszczalna liczba znak贸w dla jednego toota - Dugo tytuu - Dwa separatory po 5 znak贸w - Sze znacznik贸w nowej linii - Dugo cigu z hashtagami - Dugo linku - Trzy kropki jako zakoczenie skr贸conego opisu - 10 znak贸w rezerwowych na wszelki wypadek.

```php
$description_limit = $instance_rate_limit - strlen($title) - 10 - 6 - strlen($hashtags) - strlen($link) - 3 - 10;
```

Teraz pozostaje ju偶 tylko sprawdzi czy dugo opisu jest wiksza od limitu i je偶eli tak to skr贸ci go do dugoci wyliczonego limitu oraz doda trzy kropki na kocu. U偶yjemy do tego dw贸ch funkcji: _strlen()_ wyliczajcej dugo cigu oraz _substr()_ wycinajcej z wikszego cigu mniejszy o konkretnej dugoci zaczynajc od znaku 0 (pierwszego).

```php
if(strlen($description) > $description_limit)
{
    $description = substr($description,0,$description_limit);
    $description .= "...";
}
```

OK, mo偶emy przystpi do komponowania treci toota.

```php
$status_message = $title."\r\n";
$status_message .= "-----"."\r\n";
$status_message .= $hashtags."\r\n";
$status_message .= "-----"."\r\n";
$status_message .= $description."\r\n\r\n";
$status_message .= $link;
```

Wiadomo gotowa, wic pora przej do ustawiania parametr贸w zapytania cURL, tj. komunikacji z API Mastodona. Zaczniemy od zdefiniowania danych, kt贸re wylemy w zapytaniu, czyli:

- **status** - tre toota, kt贸r przygotowalimy,

- **language** - jzyk,

- **visibility** - widoczno toota, dostpne opcje to _public_, _unlisted_, _private_ i _direct_, ja wybraem _unlisted_, bo jednoczenie nie chc spamowa ludziom na lokalnej i globalnej osi czasu, ale te偶 chc, aby wszystkie opublikowane tooty byy widoczne na profilu bota.

```php
$status_data = array(
    "status" => $status_message,
    "language" => "pl",
    "visibility" => "unlisted"
);
```

Teraz nag贸wek, kt贸ry dla funkcji API, kt贸rej zamierzamy u偶y, tj. publikacja statusu, nie musi by obszerny, bo wystarczy, 偶e bdzie skada si tylko z instrukcji niezbdnej do autoryzacji, tj. zawierajcej nasz _token_ zdefiniowany na pocztku.

```php
$headers = [
    "Authorization: Bearer ".$token
];
```

Wszystko gotowe, wic budujemy i wykonujemy zapytanie cURL. Najpierw inicjalizacja zapytania. Potem okrelamy URL, do kt贸rego bdziemy kierowa zapytanie. W przypadku chci skorzystania z funkcji API "publikuj status (toot)" jest to - _\[URL INSTANCJI\]/api/v1/statuses_. Nastpnie nakazujemy, aby cURL u偶y standardowej metody POST po HTTP oraz zostaa zwr贸cona do nas informacja o rezultacie jaki udao si osign poprzez zapytanie (powodzenie lub np. pora偶ka i kod bdu). Na koniec doczamy wczeniej zdefiniowane nag贸wek oraz tre zasadnicz. Ostatnie dwie linijki to uruchomienie zapytania cURL, zapisanie wyniku w zmiennej _$output\_status_, niewymagane ale przydatne w celach diagnostycznych, oraz rozczenie poczenia.

```php
$ch_status = curl_init();
curl_setopt($ch_status, CURLOPT_URL, $instance_url."/api/v1/statuses");
curl_setopt($ch_status, CURLOPT_POST, 1);
curl_setopt($ch_status, CURLOPT_RETURNTRANSFER, true);
curl_setopt($ch_status, CURLOPT_HTTPHEADER, $headers);
curl_setopt($ch_status, CURLOPT_POSTFIELDS, $status_data);
                    
$output_status = json_decode(curl_exec($ch_status));
curl_close ($ch_status);
```

Na koniec ptli dodajemy jeszcze link, kt贸rego przetwarzanie zakoczylimy, do listy przeprocedowanych link贸w.

```php
$file .= $link."\n";
```

Ostatni linijk przed zakoczeniem skryptu jest jeszcze aktualizacja pliku _rzeczpospolita.txt_ o zawarto zmiennej _$file_, w kt贸rej przechowywalimy linki do wczeniej opublikowanych artyku贸w oraz tych, kt贸re zostay opublikowane podczas tego konkretnego uruchomienia skryptu.

## Bot gotowy!

Teraz pozostaje ju偶 tylko umieci kod bota na jakim hostingu lub serwerze (z np. [nginx](https://pl.m.wikipedia.org/wiki/Nginx) lub [apache](https://pl.m.wikipedia.org/wiki/Apache_HTTP_Server)). Dobrze by byo tak偶e ustawi [zadanie crona](https://pl.m.wikipedia.org/wiki/Cron), kt贸re bdzie wywoywao uruchomienie skryptu co jaki okrelony interwa czasowy (np. co 30 minut). Wikszo hosting贸w ma tak funkcj, nazywa si ona bdzie wanie zadania crona, zadania cykliczne lub co podobnego.

Wyszed z tego wpisu niezy blok tekstu, ale mam nadziej, 偶e wszystko zostao przeze mnie opisane w spos贸b klarowny. Dla r贸偶nych portali skrypt bota bdzie wymaga drobnych modyfikacji, co wynika z tego, 偶e kanay RSS, a raczej ich formatowanie, s czasem troch inne. Nie jest to jednak przeszkoda nie do pokonania. Wystarczy jedynie przejrze tre pliku XML danego feedu RSS i wprowadzi korekty.

Nie przedu偶ajc wrzuc jeszcze tylko poni偶ej linki do bot贸w, kt贸re sam uruchomiem. Koy 藕r贸dowe wszystkich trzech poni偶szych bot贸w s dostpne na [moim GitHubie](https://github.com/to3k/), wic mo偶na je sobie podejrze. Opublikowane s one na licencji MIT, czyli w zasadzie mo偶ecie zrobi z nimi co tylko chcecie. Mam tylko jedn prob - je偶eli u偶yjecie mojego kodu i stworzycie swojego bota tego typu to dajcie zna, chtnie zobacz jak Wam to wyszo, a i mo偶e bd zainteresowany obserwowaniem go 

- 叼 Rzeczpospolita - [@rzeczpospolita@101010.pl](https://101010.pl/@rzeczpospolita)

- 叼 OKO.press - [@oko\_press@101010.pl](https://101010.pl/@oko_press)

-  The Guardian - [@guardian@mastodon.world](https://mastodon.world/@guardian)
